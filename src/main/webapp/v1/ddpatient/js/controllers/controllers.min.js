var ddChatController=angular.module("ddChatController",["ionic"]);ddChatController.controller("ChatRoomCtrl",function(e,o,t,n,s,r,a,c,i,g,l,d,o,u,m,f){function p(){var e=i.defer();return m.get({fromId:S},function(o){e.resolve(o)}),e.promise}function I(){"WebSocket"in window?(U=new WebSocket("ws://www.yushansoft.com/dingdong/websck"),console.log("ws://www.yushansoft.com/dingdong/websck")):(U=new SockJS("http://www.yushansoft.com/dingdong/websck/sockjs"),console.log("http://www.yushansoft.com/dingdong/websck/sockjs")),U.onopen=function(e){console.log("WebSocket:已连接"),console.log(e)},U.onmessage=function(e){var o=JSON.parse(e.data);k.msgs.push(o),console.log("WebSocket:收到一条消息",o)},U.onclose=function(e){console.log("Info: connection closed."),console.log(e)},U.onerror=function(e){console.log("WebSocket:发生错误 "),console.log(e)}}function w(){null!=U&&(U.close(),U=null),o.websocket&&(o.websocket.close(),o.websocket=null)}var S=localStorage.getItem("ddUserId");e.ctrlScope=e;var h=new Date,y=new Date(h.getTime()-15552e6),U=null,b=e.vmDoctor={moredata:!0,doctors:[],pagination:{perPage:30,currentPage:1},init:function(){u.queryAll({size:b.pagination.perPage,page:b.pagination.currentPage,orderBy:"name",order:"ASC"},function(e){b.doctors=e.doctors,e.pages<=b.pagination.currentPage+1&&(b.moredata=!1)})},doRefresh:function(){r(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){b.pagination.currentPage+=1,b.moreDoctors&&u.queryAll({size:b.pagination.perPage,page:b.pagination.currentPage,orderBy:"name",order:"ASC"},function(o){b.doctors=b.doctors.concat(o.doctors),o.pages<=vm.pagination.currentPage+1&&(b.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}},k=e.vmMsg={moredata:!0,msgs:[],pagination:{perPage:30,currentPage:1},init:function(){f.get({userId:S,endDate:g("date")(y,"yyyy-MM-dd"),size:k.pagination.perPage,page:k.pagination.currentPage},function(e){k.msgs=e.msgs,e.pages<=k.pagination.currentPage+1&&(k.moredata=!1)})},doRefresh:function(){r(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){k.pagination.currentPage+=1,k.moreMsgs&&1==e.viewStatus&&f.get({userId:S,endDate:g("date")(y,"yyyy-MM-dd"),size:k.pagination.perPage,page:k.pagination.currentPage},function(o){k.msgs=k.msgs.concat(o.msgs),o.pages<=k.pagination.currentPage+1&&(k.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}};k.init(),b.init(),e.showSchedule=function(o){e.viewStatus=o},e.$on("$ionicView.enter",function(t){e.viewStatus=1;var n=p();n.then(function(){U||I()}).then(function(){o.websocket=U}),messageCheckTimer=a(function(){},1e3)}),e.chatIn=function(e){sessionStorage.setItem("toUserHeadImgUrl",e.fromUserHeadImgUrl),sessionStorage.setItem("toUserId",e.fromUserId),sessionStorage.setItem("toUserName",e.fromUserName),sessionStorage.setItem("endDate",g("date")(y,"yyyy-MM-dd"));var o="/userChat/"+S+"/"+e.fromUserId;l.url(o)},e.chatIn_Doctor=function(e){sessionStorage.setItem("toUserHeadImgUrl",e.headImgUrl),sessionStorage.setItem("toUserId",e.id),sessionStorage.setItem("toUserName",e.name),sessionStorage.setItem("endDate",g("date")(y,"yyyy-MM-dd"));var o="/userChat/"+S+"/"+e.id;l.url(o)},e.goBack=function(){w(),d.goBack(-1)},e.$on("$ionicView.beforeLeave",function(e){})}),ddChatController.controller("ChatMessagesCtrl",function(e,o,t,n,s,r,a,c,i,o,g,l,d){function u(){console.log("keepKeyboardOpen"),I.one("blur",function(){console.log("textarea blur, focus back on it"),I[0].focus()})}var m=localStorage.getItem("ddUserId"),f=c.doctorId,p=[];e.messages=p;var I,w=s.$getByHandle("userMessageScroll"),S=o.websocket;S.onmessage=function(o){var t=JSON.parse(o.data);e.messages.push(t),console.log("WebSocket:收到一条消息",t)},e.user={id:m,headImgUrl:"http://ionicframework.com/img/docs/mcfly.jpg",name:"Marty"},e.toUser={id:sessionStorage.getItem("toUserId"),headImgUrl:sessionStorage.getItem("toUserHeadImgUrl"),name:sessionStorage.getItem("toUserName")},e.$watch("input.message",function(e,o){console.log("input.message $watch, newValue "+e)}),l.get({fromUserId:sessionStorage.getItem("toUserId"),toUserId:m,endDate:sessionStorage.getItem("endDate"),size:30,page:1},function(o){console.log(o),angular.forEach(o.msgs,function(o,t,n){e.messages.push(o)})}),e.onMessageHold=function(o,n,s){console.log("message: "+JSON.stringify(s,null,2)),t.show({buttons:[{text:"复制信息"},{text:"删除信息"}],buttonClicked:function(o){switch(o){case 0:break;case 1:e.messages.splice(n,1),r(function(){w.resize()},0)}return!0}})},e.viewProfile=function(o){o.userId===e.user._id},e.sendMessage=function(){var o={toUserId:f,content:e.input.message};u(),o.fromUserId=m,S.send(JSON.stringify(o)),e.messages.push(o),e.input.message="",r(function(){u(),w.scrollBottom(!0)},0),r(function(){u(),w.scrollBottom(!0)},1e3)},e.$on("$ionicView.enter",function(e){r(function(){footerBar=document.body.querySelector("#userMessagesView .bar-footer"),scroller=document.body.querySelector("#userMessagesView .scroll-content"),I=angular.element(footerBar.querySelector("textarea"))},0),messageCheckTimer=a(function(){},1e3)}),e.$on("$ionicView.beforeLeave",function(e){sessionStorage.removeItem("toUserId"),sessionStorage.removeItem("toUserHeadImgUrl"),sessionStorage.removeItem("toUserName"),sessionStorage.removeItem("endDate"),d.readMsgs({toId:m},function(e){console.log("消息已阅！")})})});